---
layout: post
title: OAuth 2.0æˆæƒç æ¨¡å¼å’ŒOAuth 2.1 æˆæƒç +PKCEæ¨¡å¼æ¯”è¾ƒ
abbrlink: f95e0e64e1804e17ac245f3c696b835f
tags: []
categories:
  - IT
  - å¼€å‘
  - å®‰å…¨
date: 1761791520504
updated: 1761792121950
---

## OAuth 2.0 ä¸ OAuth 2.1 çš„åŒºåˆ«

### 1. èƒŒæ™¯

- **OAuth 2.0**ï¼šå‘å¸ƒäº 2012 å¹´ï¼ˆRFC 6749ï¼‰ï¼Œæ˜¯ç›®å‰å¹¿æ³›ä½¿ç”¨çš„æˆæƒæ¡†æ¶ã€‚
- **OAuth 2.1**ï¼šå¹¶éä¸€ä¸ªå…¨æ–°çš„åè®®ï¼Œè€Œæ˜¯å¯¹ OAuth 2.0 çš„**å®‰å…¨å¼ºåŒ–å’Œæœ€ä½³å®è·µæ•´åˆ**ã€‚å®ƒç”± OAuth å·¥ä½œç»„åœ¨ 2021 å¹´å·¦å³æå‡ºï¼ˆç›®å‰ä»æ˜¯è‰æ¡ˆï¼Œä½†å·²è¢«å¹¿æ³›é‡‡çº³ä¸ºäº‹å®æ ‡å‡†ï¼‰ã€‚

> ğŸ“Œ æ³¨æ„ï¼šOAuth 2.1 å¹¶ä¸æ˜¯ RFCï¼Œè€Œæ˜¯å¯¹ OAuth 2.0 å¤šä¸ªæ‰©å±•ï¼ˆå¦‚ PKCEã€Bearer Token å®‰å…¨æ€§ç­‰ï¼‰çš„**æ•´åˆä¸å¼ƒç”¨ä¸å®‰å…¨å®è·µ**çš„æ€»ç»“ã€‚

### 2. ä¸»è¦åŒºåˆ«

| ç‰¹æ€§                                            | OAuth 2.0                   | OAuth 2.1                                     |
| --------------------------------------------- | --------------------------- | --------------------------------------------- |
| **éšå¼æ¨¡å¼ï¼ˆImplicit Grantï¼‰**                      | âœ… æ”¯æŒï¼ˆ`response_type=token`ï¼‰ | âŒ **æ˜ç¡®å¼ƒç”¨**ï¼ˆå› å®‰å…¨é£é™©ï¼‰                             |
| **å¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentialsï¼‰** | âœ… æ”¯æŒ                        | âŒ **å¼ƒç”¨**ï¼ˆä»…é™é—ç•™ç³»ç»Ÿï¼‰                              |
| **å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼ï¼ˆClient Credentialsï¼‰**               | âœ… ä¿ç•™                        | âœ… ä¿ç•™ï¼ˆç”¨äºæœåŠ¡é—´é€šä¿¡ï¼‰                                 |
| **æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰**                 | âœ… æ”¯æŒ                        | âœ… **å¼ºåˆ¶è¦æ±‚é…åˆ PKCE**ï¼ˆå³ä½¿ confidential client ä¹Ÿæ¨èï¼‰ |
| **PKCEï¼ˆProof Key for Code Exchangeï¼‰**         | å¯é€‰æ‰©å±•ï¼ˆRFC 7636ï¼‰              | âœ… **å¼ºåˆ¶è¦æ±‚æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨**                             |
| **é‡å®šå‘ URI è¦æ±‚**                                | å»ºè®®ä¸¥æ ¼åŒ¹é…                      | âœ… **å¿…é¡»ç²¾ç¡®åŒ¹é…**ï¼ˆé˜²æ­¢å¼€æ”¾é‡å®šå‘æ”»å‡»ï¼‰                       |
| **State å‚æ•°**                                  | æ¨èä½¿ç”¨                        | âœ… **å¿…é¡»ä½¿ç”¨**ï¼ˆé˜² CSRFï¼‰                            |
| **ä»¤ç‰Œä¼ è¾“å®‰å…¨æ€§**                                   | å»ºè®® HTTPS                    | âœ… **å¼ºåˆ¶è¦æ±‚ HTTPS**                              |

### 3. æ ¸å¿ƒç†å¿µå˜åŒ–

- OAuth 2.1 çš„ç›®æ ‡æ˜¯ï¼š**â€œé»˜è®¤å®‰å…¨â€**ã€‚
- å®ƒç§»é™¤äº†å†å²ä¸Šè¢«è¯æ˜ä¸å®‰å…¨çš„æˆæƒæ–¹å¼ï¼ˆå¦‚éšå¼æ¨¡å¼ï¼‰ï¼Œå¹¶å¼ºåˆ¶ä½¿ç”¨ç°ä»£å®‰å…¨æœºåˆ¶ï¼ˆå¦‚ PKCEï¼‰ã€‚
- å³ä½¿ä½ æ˜¯ confidential clientï¼ˆæœ‰åç«¯ã€èƒ½å®‰å…¨å­˜å‚¨ client\_secretï¼‰ï¼ŒOAuth 2.1 ä¹Ÿ**æ¨èä½¿ç”¨ PKCE**ï¼Œä»¥ç»Ÿä¸€å®ç°å¹¶é˜²å¾¡æˆæƒç æ‹¦æˆªæ”»å‡»ã€‚

***

## PKCE æ¨¡å¼ vs æˆæƒç æ¨¡å¼

è¿™ä¸ªé—®é¢˜å…¶å®æœ‰ç‚¹â€œç±»åˆ«æ··æ·†â€â€”â€”**PKCE ä¸æ˜¯ä¸€ç§ç‹¬ç«‹çš„æˆæƒæ¨¡å¼ï¼Œè€Œæ˜¯å¯¹æˆæƒç æ¨¡å¼çš„å¢å¼º**ã€‚

### 1. æˆæƒç æ¨¡å¼ï¼ˆAuthorization Code Flowï¼‰

- **é€‚ç”¨åœºæ™¯**ï¼šWeb åº”ç”¨ï¼ˆæœ‰åç«¯ï¼‰ã€ä¼ ç»Ÿ OAuth 2.0ã€‚

- **æµç¨‹ç®€è¿°**ï¼š
  1. ç”¨æˆ·è®¿é—®å®¢æˆ·ç«¯ â†’ é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ï¼ˆå¸¦ `client_id`, `redirect_uri`, `scope`, `state`ï¼‰ã€‚
  2. ç”¨æˆ·ç™»å½•å¹¶æˆæƒã€‚
  3. æˆæƒæœåŠ¡å™¨é‡å®šå‘å›å®¢æˆ·ç«¯ï¼Œæºå¸¦ `code`ã€‚
  4. å®¢æˆ·ç«¯åç«¯ç”¨ `code + client_secret` å‘æˆæƒæœåŠ¡å™¨æ¢å– `access_token`ã€‚

- **å®‰å…¨å‰æ**ï¼šå®¢æˆ·ç«¯å¿…é¡»æ˜¯ **confidential client**ï¼ˆèƒ½å®‰å…¨å­˜å‚¨ `client_secret`ï¼‰ã€‚

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·æµè§ˆå™¨
    participant Client as å®¢æˆ·ç«¯ï¼ˆWeb åç«¯ï¼‰
    participant AuthServer as æˆæƒæœåŠ¡å™¨ (OAuth 2.0)

    User->>Client: è®¿é—®å—ä¿æŠ¤èµ„æº
    Client->>User: é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨<br/>ï¼ˆå« client_id, redirect_uri, scope, stateï¼‰
    User->>AuthServer: ç™»å½•å¹¶æˆæƒ
    AuthServer->>User: é‡å®šå‘å›å®¢æˆ·ç«¯ redirect_uri<br/>ï¼ˆæºå¸¦ code å’Œ stateï¼‰
    User->>Client: æµè§ˆå™¨è‡ªåŠ¨è·³è½¬ï¼Œé™„å¸¦ code
    Client->>AuthServer: åç«¯è¯·æ±‚ token endpoint<br/>ï¼ˆcode + client_id + client_secret + redirect_uriï¼‰
    AuthServer->>Client: è¿”å› access_tokenï¼ˆå¯èƒ½å« refresh_tokenï¼‰
    Client->>User: ä½¿ç”¨ access_token è·å–ç”¨æˆ·èµ„æº
```

### 2. PKCEï¼ˆProof Key for Code Exchangeï¼‰

- **ç›®çš„**ï¼šè§£å†³ **public client**ï¼ˆå¦‚ SPAã€ç§»åŠ¨ Appï¼‰æ— æ³•å®‰å…¨å­˜å‚¨ `client_secret` çš„é—®é¢˜ã€‚
- **æ ¸å¿ƒæ€æƒ³**ï¼šç”¨åŠ¨æ€ç”Ÿæˆçš„â€œä»£ç éªŒè¯å™¨â€ï¼ˆcode\_verifierï¼‰å’Œå…¶å“ˆå¸Œï¼ˆcode\_challengeï¼‰æ›¿ä»£ `client_secret`ã€‚

#### PKCE æµç¨‹ï¼ˆå åŠ åœ¨æˆæƒç æ¨¡å¼ä¸Šï¼‰ï¼š

1. å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸² `code_verifier`ã€‚
2. å¯¹å…¶è¿›è¡Œ SHA256 å“ˆå¸Œï¼Œå¾—åˆ° `code_challenge`ã€‚
3. åœ¨ç¬¬ä¸€æ­¥æˆæƒè¯·æ±‚ä¸­ï¼Œå¸¦ä¸Š `code_challenge` å’Œ `code_challenge_method=S256`ã€‚
4. ç”¨æˆ·æˆæƒåï¼Œæ‹¿åˆ° `code`ã€‚
5. å®¢æˆ·ç«¯åœ¨å…‘æ¢ token æ—¶ï¼Œ**æäº¤åŸå§‹çš„ `code_verifier`**ã€‚
6. æˆæƒæœåŠ¡å™¨ç”¨ `code_verifier` é‡æ–°è®¡ç®—å“ˆå¸Œï¼Œä¸ä¹‹å‰å­˜å‚¨çš„ `code_challenge` æ¯”å¯¹ã€‚

âœ… è¿™æ ·å³ä½¿æ”»å‡»è€…æˆªè·äº† `code`ï¼Œä¹Ÿæ— æ³•å…‘æ¢ tokenï¼ˆå› ä¸ºæ²¡æœ‰ `code_verifier`ï¼‰ã€‚

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·æµè§ˆå™¨ / App
    participant Client as å®¢æˆ·ç«¯ï¼ˆå‰ç«¯æˆ– public clientï¼‰
    participant AuthServer as æˆæƒæœåŠ¡å™¨ (æ”¯æŒ PKCE)

    Note over Client: 1. ç”Ÿæˆ code_verifier (éšæœºå­—ç¬¦ä¸²)<br/>2. è®¡ç®— code_challenge = BASE64URL(SHA256(code_verifier))

    User->>Client: å‘èµ·ç™»å½•
    Client->>AuthServer: é‡å®šå‘åˆ°æˆæƒç«¯ç‚¹<br/>ï¼ˆclient_id, redirect_uri, scope, state,<br/>code_challenge, code_challenge_method=S256ï¼‰
    User->>AuthServer: ç™»å½•å¹¶æˆæƒ
    AuthServer->>User: é‡å®šå‘å› redirect_uri<br/>ï¼ˆæºå¸¦ code å’Œ stateï¼‰
    User->>Client: æ”¶åˆ°æˆæƒç  code
    Client->>AuthServer: è¯·æ±‚ token endpoint<br/>ï¼ˆcode + code_verifier + client_id + redirect_uriï¼‰
    AuthServer->>AuthServer: éªŒè¯ code_verifier â†’ é‡æ–°è®¡ç®— SHA256 å¹¶æ¯”å¯¹ code_challenge
    AuthServer->>Client: éªŒè¯é€šè¿‡ï¼Œè¿”å› access_token
    Client->>User: ä½¿ç”¨ access_token è°ƒç”¨ API
```

### 3. å…³é”®åŒºåˆ«æ€»ç»“

| ç»´åº¦                   | æˆæƒç æ¨¡å¼ï¼ˆä¼ ç»Ÿï¼‰                               | æˆæƒç  + PKCE                              |
| -------------------- | --------------------------------------- | --------------------------------------- |
| æ˜¯å¦éœ€è¦ `client_secret` | âœ… éœ€è¦ï¼ˆconfidential clientï¼‰               | âŒ ä¸éœ€è¦ï¼ˆé€‚ç”¨äº public clientï¼‰                |
| å®‰å…¨æ€§                  | ä¾èµ– `client_secret` ä¿å¯†                   | ä¾èµ–åŠ¨æ€ `code_verifier`ï¼ˆæ¯æ¬¡ä¸åŒï¼‰              |
| é€‚ç”¨å®¢æˆ·ç«¯ç±»å‹              | Web åç«¯åº”ç”¨                                | SPAã€ç§»åŠ¨ Appã€æ¡Œé¢åº”ç”¨ã€ç”šè‡³ Web åº”ç”¨ï¼ˆOAuth 2.1 æ¨èï¼‰ |
| æ˜¯å¦é˜²æˆæƒç æ‹¦æˆª             | âŒ è‹¥ `code` è¢«æˆªè·ä¸”æ”»å‡»è€…æœ‰ `client_secret`ï¼Œå¯ç›—ç”¨ | âœ… å³ä½¿ `code` è¢«æˆªè·ï¼Œæ—  `code_verifier` ä¹Ÿæ— æ³•ä½¿ç”¨ |

> ğŸ’¡ ç°ä»£æœ€ä½³å®è·µï¼ˆåŒ…æ‹¬ OAuth 2.1ï¼‰ï¼š**æ‰€æœ‰æˆæƒç æµç¨‹éƒ½åº”ä½¿ç”¨ PKCE**ï¼Œæ— è®ºæ˜¯å¦æ˜¯ public clientã€‚

***

## æ€»ç»“

- **OAuth 2.1 â‰  å…¨æ–°åè®®**ï¼Œè€Œæ˜¯ OAuth 2.0 çš„**å®‰å…¨åŠ å›ºç‰ˆ**ï¼Œå¼ƒç”¨ä¸å®‰å…¨æ¨¡å¼ï¼Œå¼ºåˆ¶ PKCE å’Œ HTTPSã€‚
- **PKCE ä¸æ˜¯æ›¿ä»£æˆæƒç æ¨¡å¼ï¼Œè€Œæ˜¯å…¶å®‰å…¨å¢å¼º**ï¼Œç”¨äºé˜²æ­¢æˆæƒç è¢«æ»¥ç”¨ï¼Œå°¤å…¶é€‚ç”¨äºæ— æ³•ä¿å¯† `client_secret` çš„åœºæ™¯ã€‚
- **ç°ä»£åº”ç”¨åº”ä¸€å¾‹ä½¿ç”¨â€œæˆæƒç  + PKCEâ€**ï¼Œå³ä½¿æ˜¯åç«¯æœåŠ¡ã€‚
